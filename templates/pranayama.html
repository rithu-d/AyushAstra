{% extends "base.html" %}

{% block title %}Pranayama & Breathing - AyushAstra{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-ayurvedic-cream to-white py-12">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="text-center mb-12">
            <div class="text-6xl mb-4">ü´Å</div>
            <h2 class="text-4xl font-bold text-gray-800 mb-4">Pranayama & Breathing</h2>
            <p class="text-xl text-gray-600 max-w-3xl mx-auto">
                Master the art of conscious breathing with traditional Pranayama techniques.
                These exercises help balance your energy, calm your mind, and improve overall well-being.
            </p>
        </div>

        <!-- Introduction -->
        <div class="bg-white/80 backdrop-blur-sm rounded-2xl p-8 shadow-lg border border-gray-200 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="text-center">
                    <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-wind text-blue-600 text-2xl"></i>
                    </div>
                    <h3 class="font-semibold text-gray-800 mb-2">Breath Control</h3>
                    <p class="text-sm text-gray-600">
                        Learn to control your breath to influence your nervous system and energy levels
                    </p>
                </div>
                <div class="text-center">
                    <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="text-2xl">üßò</span>
                    </div>
                    <h3 class="font-semibold text-gray-800 mb-2">Mind Calming</h3>
                    <p class="text-sm text-gray-600">
                        Reduce stress and anxiety through specific breathing patterns and techniques
                    </p>
                </div>
                <div class="text-center">
                    <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="text-2xl">‚ö°</span>
                    </div>
                    <h3 class="font-semibold text-gray-800 mb-2">Energy Balance</h3>
                    <p class="text-sm text-gray-600">
                        Balance your body's energy systems for optimal health and vitality
                    </p>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="mb-8">
            <div class="bg-white/80 backdrop-blur-sm rounded-2xl p-6 shadow-lg border border-gray-200">
                <!-- Search -->
                <div class="mb-6">
                    <div class="relative max-w-md mx-auto">
                        <input type="text" id="pranayama-search" placeholder="Search breathing exercises..."
                            class="w-full px-4 py-3 pr-10 border border-gray-300 rounded-lg focus:border-ayurvedic-green focus:outline-none" />
                        <i class="fas fa-search absolute right-3 top-3.5 text-gray-400"></i>
                    </div>
                </div>

                <!-- Condition Filter -->
                <div>
                    <h3 class="text-sm font-medium text-gray-700 mb-3 flex items-center gap-2">
                        <i class="fas fa-filter"></i>
                        Health Condition
                    </h3>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="filterByCondition('All')"
                            class="condition-btn px-3 py-1 rounded-full text-sm border border-gray-300 hover:ayurvedic-green hover:text-white transition-colors ayurvedic-green text-white">All</button>
                        <button onclick="filterByCondition('Anxiety')"
                            class="condition-btn px-3 py-1 rounded-full text-sm border border-gray-300 hover:ayurvedic-green hover:text-white transition-colors">Anxiety</button>
                        <button onclick="filterByCondition('Stress')"
                            class="condition-btn px-3 py-1 rounded-full text-sm border border-gray-300 hover:ayurvedic-green hover:text-white transition-colors">Stress</button>
                        <button onclick="filterByCondition('Poor Concentration')"
                            class="condition-btn px-3 py-1 rounded-full text-sm border border-gray-300 hover:ayurvedic-green hover:text-white transition-colors">Poor
                            Concentration</button>
                        <button onclick="filterByCondition('Insomnia')"
                            class="condition-btn px-3 py-1 rounded-full text-sm border border-gray-300 hover:ayurvedic-green hover:text-white transition-colors">Insomnia</button>
                        <button onclick="filterByCondition('Low Energy')"
                            class="condition-btn px-3 py-1 rounded-full text-sm border border-gray-300 hover:ayurvedic-green hover:text-white transition-colors">Low
                            Energy</button>
                        <button onclick="filterByCondition('Headaches')"
                            class="condition-btn px-3 py-1 rounded-full text-sm border border-gray-300 hover:ayurvedic-green hover:text-white transition-colors">Headaches</button>
                        <button onclick="filterByCondition('Anger')"
                            class="condition-btn px-3 py-1 rounded-full text-sm border border-gray-300 hover:ayurvedic-green hover:text-white transition-colors">Anger</button>
                        <button onclick="filterByCondition('Respiratory Issues')"
                            class="condition-btn px-3 py-1 rounded-full text-sm border border-gray-300 hover:ayurvedic-green hover:text-white transition-colors">Respiratory
                            Issues</button>
                        <button onclick="filterByCondition('Digestive Issues')"
                            class="condition-btn px-3 py-1 rounded-full text-sm border border-gray-300 hover:ayurvedic-green hover:text-white transition-colors">Digestive
                            Issues</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Count -->
        <div class="mb-6">
            <p id="results-count" class="text-gray-600">
                Showing {{ pranayama_exercises|length }} breathing exercise{{ 's' if pranayama_exercises|length != 1
                else '' }}
            </p>
        </div>

        <!-- Exercises Grid -->
        <div id="pranayama-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for exercise in pranayama_exercises %}
            <div class="pranayama-card bg-white rounded-lg shadow-lg hover:shadow-xl transition-all duration-300 hover:-translate-y-1"
                data-conditions="{{ exercise.conditions|join(',') }}">
                <div class="p-6">
                    <!-- Header -->
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-gray-800 mb-1">{{ exercise.name }}</h3>
                            <p class="text-sm text-ayurvedic-sage italic">{{ exercise.sanskrit_name }}</p>
                        </div>
                    </div>

                    <!-- Breathing Circle Animation -->
                    <div class="flex flex-col items-center gap-3 mb-4">
                        <div class="relative">
                            <div id="breathing-circle-{{ exercise.id }}"
                                class="w-32 h-32 rounded-full border-4 border-ayurvedic-green bg-gray-50 transition-all duration-1000 flex items-center justify-center">
                                <i class="fas fa-wind text-gray-400 text-2xl"></i>
                            </div>
                        </div>
                        <span id="breathing-text-{{ exercise.id }}" class="text-sm font-medium text-gray-500">
                            Ready
                        </span>
                    </div>

                    <!-- Timer -->
                    <div class="text-center mb-4">
                        <div id="timer-{{ exercise.id }}"
                            class="text-3xl font-mono font-bold text-gray-800 tracking-widest">
                            01:00
                        </div>
                        <div class="text-sm text-gray-500">
                            {{ exercise.breathing_pattern }}
                        </div>
                    </div>

                    <!-- Controls -->
                    <div class="flex justify-center gap-3 mb-4">
                        <button onclick="startExercise('{{ exercise.id }}')" id="start-btn-{{ exercise.id }}"
                            class="ayurvedic-green text-white px-4 py-2 rounded-lg hover:bg-ayurvedic-sage transition-colors flex items-center gap-2">
                            <i class="fas fa-play"></i>
                            Start
                        </button>
                        <button onclick="resetExercise('{{ exercise.id }}')"
                            class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors flex items-center gap-2">
                            <i class="fas fa-redo"></i>
                            Reset
                        </button>
                    </div>

                    <!-- Benefits -->
                    <div class="mb-4">
                        <h4 class="font-medium text-gray-700 mb-2 flex items-center gap-2">
                            <i class="fas fa-wind text-blue-500"></i>
                            Benefits
                        </h4>
                        <ul class="text-sm text-gray-600 space-y-1">
                            {% for benefit in exercise.benefits[:3] %}
                            <li class="flex items-start gap-2">
                                <span class="text-ayurvedic-green mt-1">‚Ä¢</span>
                                {{ benefit }}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>

                    <!-- Duration -->
                    <div class="flex items-center gap-2 text-sm text-gray-600 mb-4">
                        <i class="fas fa-clock text-blue-500"></i>
                        <span>{{ exercise.duration }}</span>
                    </div>

                    <!-- Actions -->
                    <div class="flex gap-2">
                        <button onclick="showExerciseDetails('{{ exercise.id }}')"
                            class="flex-1 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors px-4 py-2">
                            Learn More
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- No Results -->
        <div id="no-results" class="text-center py-12 hidden">
            <div class="text-6xl mb-4">ü´Å</div>
            <h3 class="text-xl font-semibold text-gray-700 mb-2">No exercises found</h3>
            <p class="text-gray-500">
                Try adjusting your filters or search terms to find the perfect breathing exercise for you.
            </p>
        </div>

        <!-- Safety Guidelines -->
        <div class="mt-12 bg-blue-50 border border-blue-200 rounded-lg p-6">
            <h3 class="text-lg font-semibold text-blue-800 mb-2">Safety Guidelines</h3>
            <ul class="list-disc list-inside text-blue-700 space-y-1">
                <li>‚Ä¢ Consult a healthcare professional if you have respiratory conditions</li>
                <li>‚Ä¢ Practice on an empty stomach or at least 2-3 hours after a meal</li>
                <li>‚Ä¢ If you feel dizzy or uncomfortable, stop immediately and rest</li>
                <li>‚Ä¢ Pregnant women and individuals with high blood pressure should consult an expert
                    before practicing</li>
            </ul>
        </div>
    </div>
</div>

<!-- Exercise Details Modal -->
<div id="exercise-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <!-- Modal Card -->
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl flex flex-col max-h-[85vh]">
        <!-- Header (Fixed) -->
        <div
            class="flex-none px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-white rounded-t-lg">
            <h3 id="modal-title" class="text-2xl font-bold text-gray-800"></h3>
            <button onclick="closeExerciseModal()"
                class="text-gray-500 hover:text-gray-700 transition-colors p-2 rounded-full hover:bg-gray-100">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <!-- Content (Scrollable) -->
        <div class="flex-1 overflow-y-auto p-6 min-h-0">
            <div id="modal-content" class="space-y-4">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const pranayamaExercises = {{ pranayama_exercises| tojson }};
    const DEFAULT_TIMER_SECONDS = 60;
    let exerciseTimers = {};
    let currentCondition = 'All';
    const exerciseStates = {};

    function filterByCondition(condition) {
        currentCondition = condition;
        updateFilters();
        filterExercises();
    }

    function updateFilters() {
        document.querySelectorAll('.condition-btn').forEach(btn => {
            if (btn.textContent.trim() === currentCondition) {
                btn.classList.add('ayurvedic-green', 'text-white');
                btn.classList.remove('border-gray-300');
            } else {
                btn.classList.remove('ayurvedic-green', 'text-white');
                btn.classList.add('border-gray-300');
            }
        });
    }

    function filterExercises() {
        const searchTerm = document.getElementById('pranayama-search').value.toLowerCase();
        const cards = document.querySelectorAll('.pranayama-card');
        let visibleCount = 0;

        cards.forEach(card => {
            const conditions = card.dataset.conditions.toLowerCase();
            const exerciseName = card.querySelector('h3').textContent.toLowerCase();
            const sanskritName = card.querySelector('p').textContent.toLowerCase();

            const matchesCondition = currentCondition === 'All' ||
                conditions.includes(currentCondition.toLowerCase());
            const matchesSearch = searchTerm === '' || exerciseName.includes(searchTerm) ||
                sanskritName.includes(searchTerm);

            if (matchesCondition && matchesSearch) {
                card.style.display = 'block';
                visibleCount++;
            } else {
                card.style.display = 'none';
            }
        });

        document.getElementById('results-count').textContent =
            `Showing ${visibleCount} breathing exercise${visibleCount !== 1 ? 's' : ''}`;

        const noResults = document.getElementById('no-results');
        if (visibleCount === 0) {
            noResults.classList.remove('hidden');
        } else {
            noResults.classList.add('hidden');
        }
    }

    function getExerciseState(exerciseId) {
        if (!exerciseStates[exerciseId]) {
            exerciseStates[exerciseId] = {
                remaining: DEFAULT_TIMER_SECONDS,
                isRunning: false,
                phase: 'inhale',
                phaseTime: 0
            };
        }
        return exerciseStates[exerciseId];
    }

    function formatTime(totalSeconds) {
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function updateTimerDisplay(exerciseId) {
        const timer = document.getElementById(`timer-${exerciseId}`);
        const state = getExerciseState(exerciseId);
        timer.textContent = formatTime(state.remaining);
    }

    function updateBreathingVisuals(exerciseId) {
        const circle = document.getElementById(`breathing-circle-${exerciseId}`);
        const text = document.getElementById(`breathing-text-${exerciseId}`);
        const state = getExerciseState(exerciseId);

        const phaseDurations = { inhale: 4, hold: 4, exhale: 6 };
        const settings = {
            inhale: { scale: 1.15, color: '#bbf7d0', label: 'Inhale' },
            hold: { scale: 1.05, color: '#fde68a', label: 'Hold' },
            exhale: { scale: 0.9, color: '#bfdbfe', label: 'Exhale' }
        };

        if (state.phaseTime >= phaseDurations[state.phase]) {
            state.phaseTime = 0;
            state.phase = state.phase === 'inhale'
                ? 'hold'
                : state.phase === 'hold'
                    ? 'exhale'
                    : 'inhale';
        }

        const phaseSetting = settings[state.phase];
        circle.style.transform = `scale(${phaseSetting.scale})`;
        circle.style.backgroundColor = phaseSetting.color;
        text.textContent = phaseSetting.label;
    }

    function tickExercise(exerciseId) {
        const state = getExerciseState(exerciseId);
        if (!state.isRunning) return;

        state.remaining = Math.max(state.remaining - 1, 0);
        state.phaseTime += 1;

        updateTimerDisplay(exerciseId);
        updateBreathingVisuals(exerciseId);

        if (state.remaining === 0) {
            completeExercise(exerciseId);
        }
    }

    function startExercise(exerciseId) {
        const state = getExerciseState(exerciseId);
        const button = document.getElementById(`start-btn-${exerciseId}`);

        if (state.isRunning) {
            pauseExercise(exerciseId);
            return;
        }

        state.isRunning = true;
        button.innerHTML = '<i class="fas fa-pause"></i> Pause';
        updateBreathingVisuals(exerciseId);

        if (!exerciseTimers[exerciseId]) {
            exerciseTimers[exerciseId] = setInterval(() => tickExercise(exerciseId), 1000);
        }
    }

    function pauseExercise(exerciseId) {
        const state = getExerciseState(exerciseId);
        state.isRunning = false;

        clearInterval(exerciseTimers[exerciseId]);
        exerciseTimers[exerciseId] = null;

        const button = document.getElementById(`start-btn-${exerciseId}`);
        const circle = document.getElementById(`breathing-circle-${exerciseId}`);
        const text = document.getElementById(`breathing-text-${exerciseId}`);

        button.innerHTML = '<i class="fas fa-play"></i> Resume';
        circle.style.transform = 'scale(1)';
        circle.style.backgroundColor = '#f9fafb';
        text.textContent = 'Paused';
    }

    function completeExercise(exerciseId) {
        const state = getExerciseState(exerciseId);
        state.isRunning = false;
        state.remaining = DEFAULT_TIMER_SECONDS;
        state.phase = 'inhale';
        state.phaseTime = 0;

        clearInterval(exerciseTimers[exerciseId]);
        exerciseTimers[exerciseId] = null;

        const button = document.getElementById(`start-btn-${exerciseId}`);
        const circle = document.getElementById(`breathing-circle-${exerciseId}`);
        const text = document.getElementById(`breathing-text-${exerciseId}`);

        button.innerHTML = '<i class="fas fa-play"></i> Start';
        circle.style.transform = 'scale(1)';
        circle.style.backgroundColor = '#f9fafb';
        text.textContent = 'Complete';
        updateTimerDisplay(exerciseId);
    }

    function resetExercise(exerciseId) {
        const state = getExerciseState(exerciseId);
        state.isRunning = false;
        state.remaining = DEFAULT_TIMER_SECONDS;
        state.phase = 'inhale';
        state.phaseTime = 0;

        clearInterval(exerciseTimers[exerciseId]);
        exerciseTimers[exerciseId] = null;

        const button = document.getElementById(`start-btn-${exerciseId}`);
        const circle = document.getElementById(`breathing-circle-${exerciseId}`);
        const text = document.getElementById(`breathing-text-${exerciseId}`);

        button.innerHTML = '<i class="fas fa-play"></i> Start';
        circle.style.transform = 'scale(1)';
        circle.style.backgroundColor = '#f9fafb';
        text.textContent = 'Ready';
        updateTimerDisplay(exerciseId);
    }

    function showExerciseDetails(exerciseId) {
        const exercise = pranayamaExercises.find(e => e.id === exerciseId);
        if (!exercise) return;

        document.getElementById('modal-title').textContent = exercise.name;
        document.getElementById('exercise-modal').classList.remove('hidden');
        document.body.style.overflow = 'hidden'; // Prevent background scrolling

        const content = `
<div class="space-y-4">
    <div>
        <h4 class="font-semibold text-gray-800 mb-2">Sanskrit Name</h4>
        <p class="text-ayurvedic-sage italic">${exercise.sanskrit_name}</p>
    </div>

    <div>
        <h4 class="font-semibold text-gray-800 mb-2">Description</h4>
        <p class="text-gray-600">${exercise.description}</p>
    </div>

    <div>
        <h4 class="font-semibold text-gray-800 mb-2">Benefits</h4>
        <ul class="list-disc list-inside text-gray-600 space-y-1">
            ${exercise.benefits.map(benefit => `<li>${benefit}</li>`).join('')}
        </ul>
    </div>

    <div>
        <h4 class="font-semibold text-gray-800 mb-2">Instructions</h4>
        <ol class="list-decimal list-inside text-gray-600 space-y-1">
            ${exercise.instructions.map(instruction => `<li>${instruction}</li>`).join('')}
        </ol>
    </div>

    <div>
        <h4 class="font-semibold text-gray-800 mb-2">Breathing Pattern</h4>
        <p class="text-gray-600">${exercise.breathing_pattern}</p>
    </div>

    <div>
        <h4 class="font-semibold text-gray-800 mb-2">Duration</h4>
        <p class="text-gray-600">${exercise.duration}</p>
    </div>

    ${exercise.precautions.length > 0 ? `
    <div>
        <h4 class="font-semibold text-gray-800 mb-2">Precautions</h4>
        <ul class="list-disc list-inside text-amber-600 space-y-1">
            ${exercise.precautions.map(precaution => `<li>${precaution}</li>`).join('')}
        </ul>
    </div>
    ` : ''}
</div>
`;

        document.getElementById('modal-content').innerHTML = content;
    }

    function closeExerciseModal() {
        document.getElementById('exercise-modal').classList.add('hidden');
        document.body.style.overflow = ''; // Restore background scrolling
    }

    // Search functionality
    document.getElementById('pranayama-search').addEventListener('input', filterExercises);

    // Close modal when clicking outside
    document.getElementById('exercise-modal').addEventListener('click', function (e) {
        if (e.target === this) {
            closeExerciseModal();
        }
    });
</script>
{% endblock %}